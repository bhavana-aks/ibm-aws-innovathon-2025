version: 1
applications:
  - appRoot: frontend
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            # Write server-side environment variables to .env.production for runtime access
            - echo "APP_AWS_REGION=$APP_AWS_REGION" >> .env.production
            - echo "APP_AWS_ACCESS_KEY_ID=$APP_AWS_ACCESS_KEY_ID" >> .env.production
            - echo "APP_AWS_SECRET_ACCESS_KEY=$APP_AWS_SECRET_ACCESS_KEY" >> .env.production
            - echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> .env.production
            - echo "DYNAMODB_TABLE_NAME=$DYNAMODB_TABLE_NAME" >> .env.production
            - echo "ECS_CLUSTER_NAME=$ECS_CLUSTER_NAME" >> .env.production
            - echo "ECS_TASK_FAMILY=$ECS_TASK_FAMILY" >> .env.production
            - echo "ECS_SUBNETS=$ECS_SUBNETS" >> .env.production
            - echo "ECS_SECURITY_GROUPS=$ECS_SECURITY_GROUPS" >> .env.production
            # Write public variables (accessible on client-side)
            - echo "NEXT_PUBLIC_BASE_URL=$NEXT_PUBLIC_BASE_URL" >> .env.production
            - echo "NEXT_PUBLIC_AWS_REGION=$NEXT_PUBLIC_AWS_REGION" >> .env.production
            - echo "NEXT_PUBLIC_COGNITO_USER_POOL_ID=$NEXT_PUBLIC_COGNITO_USER_POOL_ID" >> .env.production
            - echo "NEXT_PUBLIC_COGNITO_CLIENT_ID=$NEXT_PUBLIC_COGNITO_CLIENT_ID" >> .env.production
          # Debug: show what was written
          #  - cat .env.production
        build:
          commands:
            - npm run build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*

